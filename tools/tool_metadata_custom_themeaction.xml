<?xml version="1.0" encoding="UTF-8"?>
<tool type="themeaction">
    <cbinfo-metadata>
        <param name="tool.help.text">Hjælpetext til custom metadatamodul</param>
    </cbinfo-metadata>

    <displayname><![CDATA[[Se temaets metadata]]]></displayname>
    <description><![CDATA[[Et værktøj til at kigge på eller editere i metadata på temaet.]]]></description>

    <src><![CDATA[[
        themeActions.registerAction(new ThemeAction({
            name: 'metadata_custom',

            actionfunction: theme => {
                theme.show()
                var dialog = new Dialog({
                    id: 'metadata_dialog',
                    title: 'Metadata',
                    resizable: {
                        x: true,
                        y: false
                    },
                    minwidth: 300
                })

                var ds = spm.getSession().getDatasource('ds_metadata')

                ds.execute({command: 'read-metadata-for-theme', theme: theme.name}, resp => {
                    var user_short = spm.getSession().getPrincipal().shortid
                    var user_long = spm.getSession().getPrincipal().name
                    if (resp.length > 0) {

                        var metadata = resp[0]
                        var html = `
                            <h2>${theme._displayname}</h2><br>
                            <div id="metadata" style="display: grid;">
                                <label for="ansvarlig">Ansvarlig</label>
                                <input style="cursor: not-allowed;" type="text" id="ansvarlig" readonly>

                                <label for="ansvarlig_short">Ansvarlig (windows brugernavn)</label>
                                <input style="cursor: not-allowed;" type="text" id="ansvarlig_short" readonly>

                                <label for="email">Email</label>
                                <input style="cursor: not-allowed;" type="text" id="email" readonly>

                                <label for="afdeling">Afdeling</label>
                                <input style="cursor: not-allowed;" type="text" id="afdeling" readonly>

                                <label for="center">Center</label>
                                <input style="cursor: not-allowed;" type="text" id="center" readonly>

                                <label for="beskrivelse">Beskrivelse</label>
                                <textarea id="beskrivelse" name="beskrivelse" readonly style="width: 100%; resize: none; cursor: not-allowed" rows="5">${metadata.beskrivelse}</textarea>

                                <label for="status">Status</label>
                                <input style="cursor: not-allowed;" type="text" id="status" readonly>

                                <label for="frekvens">Ajourføringsfrekvens</label>
                                <input style="cursor: not-allowed;" type="text" id="frekvens" readonly>

                                <label for="revision_dato">Metadata sidst opdateret</label>
                                <input type="date" id="revision_dato" disabled>
                            </div>`
                        dialog.addContentHTML(html)
                        
                        document.getElementById('ansvarlig').value = metadata.dataejer;
                        document.getElementById('ansvarlig_short').value = metadata.dataejer_short;
                        document.getElementById('email').value = metadata.dataejer_email;
                        document.getElementById('afdeling').value = metadata.afdeling;
                        document.getElementById('center').value = metadata.center;
                        document.getElementById('status').value = metadata.status;
                        document.getElementById('frekvens').value = metadata.opdaterings_frekvens;
                        document.getElementById('revision_dato').value = metadata.revision_dato.split(' ')[0];

                        dialog.addButtonsHTML(`
                                            <div style='text-align: right;'>
                                                <button id="gemBtn" disabled>Gem metadata</button>
                                            </div>
                                            <label for="rediger">Rediger metadata</label>
                                            <input type="checkbox" id="redigerCheckbox">`)
                        
                        dialog.showDialog()

                        var redigerCheckboxEl = document.getElementById('redigerCheckbox')
                        var gemBtnEl = document.getElementById('gemBtn')

                        redigerCheckboxEl.addEventListener('change', () => {
                            var inputEls = document.querySelectorAll('#metadata input, #metadata textarea')
                            gemBtnEl.removeAttribute('disabled')
                            if (redigerCheckboxEl.checked) {
                                inputEls.forEach(el => {
                                    el.removeAttribute('readonly')
                                    el.style.cursor = 'auto'
                                })
                            } else if (!redigerCheckboxEl.checked) {
                                gemBtnEl.setAttribute('disabled', '')
                                inputEls.forEach(el => {
                                    if (el.type != 'date') {
                                        el.setAttribute('readonly', '')
                                        el.style.cursor = 'not-allowed'
                                    }
                                })
                            }
                        })

                        document.getElementById('gemBtn').addEventListener('click', () => {
                            ds.execute({
                                command: 'update-theme-metadata',
                                beskrivelse: document.getElementById('beskrivelse').value,
                                dataejer: document.getElementById('ansvarlig').value,
                                dataejer_short: document.getElementById('ansvarlig_short').value,
                                dataejer_email: document.getElementById('email').value,
                                status: document.getElementById('status').value,
                                afdeling: document.getElementById('afdeling').value,
                                center: document.getElementById('center').value,
                                opdaterings_frekvens: document.getElementById('frekvens').value,
                                user_short: user_short,
                                user_long: user_long,
                                id: metadata.id
                            }, () => {
                                toastr.success('Metadata gemt', 'Success')
                            })
                        })
                    } else {
                        var html = `
                            <h2>${theme._displayname}</h2><br>
                            <div id="metadata" style="display: grid;">
                                <label for="ansvarlig">Ansvarlig</label>
                                <input placeholder="Indtast dataejers navn" type="text" id="ansvarlig">

                                <label for="ansvarlig_short">Ansvarlig brugernavn</label>
                                <input placeholder="Indtast windows brugernavn" type="text" id="ansvarlig_short">

                                <label for="email">Email</label>
                                <input placeholder="Indtast dataejers email" type="text" id="email">

                                <label for="afdeling">Afdeling</label>
                                <input placeholder="Indtast dataejers afdeling" type="text" id="afdeling">

                                <label for="center">Center</label>
                                <input placeholder="Indtast dataejers center" type="text" id="center">

                                <label for="beskrivelse">Beskrivelse</label>
                                <textarea placeholder="Beskriv datasættet og hvad det f.eks. bliver brugt til" id="beskrivelse" name="beskrivelse" style="width: 100%; resize: none;" rows="5"></textarea>

                                <label for="status">Status</label>
                                <input placeholder="Angiv datasættets status" type="text" id="status">

                                <label for="frekvens">Ajourføringsfrekvens</label>
                                <input placeholder="Hvor ofte bliver data opdateret?" type="text" id="frekvens">
                            </div>`
                        dialog.addContentHTML(html)
                        dialog.addButtonsHTML(`
                                            <div style='text-align: right;'>
                                                <button id="gemBtn">Gem metadata</button>
                                            </div>`)
                        
                        dialog.showDialog()

                        var redigerCheckboxEl = document.getElementById('redigerCheckbox')
                        var gemBtnEl = document.getElementById('gemBtn')

                        document.getElementById('gemBtn').addEventListener('click', () => {
                            var validate = {
                                dataejer: document.getElementById('ansvarlig').value,
                                dataejer_short:  document.getElementById('ansvarlig_short').value,
                                dataejer_email: document.getElementById('email').value,
                                status: document.getElementById('status').value,
                                opdaterings_frekvens: document.getElementById('frekvens').value
                            }

                            if (Object.values(validate).includes('')) {
                                let dataejer = document.getElementById('ansvarlig')
                                let dataejer_short = document.getElementById('ansvarlig_short')
                                let dataejer_email = document.getElementById('email')
                                let status = document.getElementById('status')
                                let opdaterings_frekvens = document.getElementById('frekvens')

                                dataejer.style.borderColor = '#ff000030'
                                dataejer_short.style.borderColor = '#ff000030'
                                dataejer_email.style.borderColor = '#ff000030'
                                status.style.borderColor = '#ff000030'
                                opdaterings_frekvens.style.borderColor = '#ff000030'

                                toastr.error('Mangler værdier. Kan ikke gemme!', 'Fejl')
                            } else {
                                ds.execute({
                                    command: 'create-theme-metadata',
                                    beskrivelse: document.getElementById('beskrivelse').value,
                                    dataejer: document.getElementById('ansvarlig').value,
                                    dataejer_short: document.getElementById('ansvarlig_short').value,
                                    dataejer_email: document.getElementById('email').value,
                                    theme: theme.name,
                                    status: document.getElementById('status').value,
                                    afdeling: document.getElementById('afdeling').value,
                                    center: document.getElementById('center').value,
                                    opdaterings_frekvens: document.getElementById('frekvens').value,
                                    revision_user_short: user_short,
                                    revision_user_long: user_long
                                }, () => {
                                    toastr.success('Metadata gemt', 'Success')
                                    dialog.close()
                                })
                            }
                        })
                    }

                })



            },

            conditionfunction: theme => {
                if (theme.initialConfig.primaryendpointtype == 'postgis') {
                    return true
                }
            },

            buttonoptions: {
                tooltip: 'Se metadata for tema',
				icon: spatialmap.gui.SKIN_PATH_AND_NAME + "/images/buttons/meta.png"
            }
        }))
    ]]]></src>
    

</tool>